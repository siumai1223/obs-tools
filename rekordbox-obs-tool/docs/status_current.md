# プロジェクト状況記録

## 最新の進捗 (2024-03-17)

### 実装済みの機能
1. rekordboxデータベース連携
   - ✅ データベースへの接続機能
   - ✅ 曲情報の取得（タイトル、アーティスト、キー）
   - ✅ BPM値の正しい取得（100倍の整数値から実際のBPM値への変換）
   - ✅ 再生履歴の取得（直近1週間）
   - ✅ 再生日時の表示
   - ✅ 曲の解析状態の確認機能
   - ✅ 現在再生中の曲情報のリアルタイム取得機能

2. 表示情報
   - タイトル
   - アーティスト名
   - BPM
   - キー
   - 最終再生日時
   - 再生回数
   - 解析状態

### データベース調査結果
1. 曲の解析状態について
   - 解析済みの曲は`Analysed`値が`105`
   - 解析データは`/PIONEER/USBANLZ/...`に保存
   - 解析時に`updated_at`が更新される

2. 曲情報の更新について
   - `AnalysisUpdated`: 解析の更新回数を記録
   - `TrackInfoUpdated`: トラック情報の更新回数を記録
   - `updated_at`: 最後の更新日時

3. 再生情報
   - `DJPlayCount`: 累積再生回数
   - `LastPlayed`: 最終再生日時

### 修正された問題
1. BPM値が0として取得される問題
   - 原因：データベースに保存されているBPM値が100倍の整数値として保存されていた
   - 解決：BPM値を100で割って正しい値に変換するように修正

2. 履歴の日付情報
   - `updated_at`を使用して最後に再生された日時を取得するように変更
   - 直近1週間の履歴のみを表示するようにフィルタリング
   - 最新の再生日時順にソート

### 技術的な詳細
- pyrekordboxライブラリを使用してrekordboxデータベースに接続
- BPM値は整数値（実際のBPM×100）として保存されていることが判明
- 履歴の取得には`updated_at`フィールドを使用
- ログレベルをDEBUGに設定し、詳細なデバッグ情報を出力

## 既知の問題と対応状況

### アートワーク情報
- アートワーク情報が取得できない問題
- データベース上のアートワーク情報が失われている可能性
- 外部ソース（iTunes等）からの再取得機能の実装を検討中

### 現在再生中の曲情報
- リアルタイムでの再生中の曲情報取得が未実装
- 現在はデータベース内の最初の曲を表示

## 削除された機能
- バックアップ/リストア機能
  - データ損失のリスクを考慮して削除
  - `backup_db.py`と`restore_db.py`を削除

## 次のステップ
1. OBS連携機能の実装
   - 現在再生中の曲情報をOBSに表示
   - テキストソースの自動更新機能
   - 解析状態に基づく表示の制御

2. データベース監視機能の改善
   - 解析状態（Analysed=105）に基づく曲の選別
   - 解析データの保存場所の監視
   - 更新イベントの適切な処理

3. アートワーク情報の復元（新規ブランチで対応予定）
   - iTunesなどの外部ソースからアートワーク取得
   - rekordboxデータベースへのアートワーク適用
   - 詳細は別途計画書参照

4. その他の改善
   - UIの改善
   - エラーハンドリングの強化
   - テストケースの追加

## 開発方針

### Git ワークフロー

#### Pushのタイミング
1. 作業の進捗保存
   - 論理的な作業単位の完了時
   - 1日の作業終了時
   - ローカルの変更をバックアップする目的

2. 頻度
   - 比較的頻繁（1日に複数回も可）
   - 小さな変更でもOK
   - 作業ブランチが安定した状態であれば随時

3. プッシュ前のチェックリスト
   - コードが正常に動作することを確認
   - 不要なファイルが含まれていないことを確認
   - コミットメッセージが適切であることを確認

#### Pull Requestのタイミング
1. 機能の完成時
   - 機能実装が完全に完了
   - テストが全て通過
   - ドキュメントの更新も完了

2. 頻度
   - 比較的少ない（機能単位）
   - まとまった変更がある時
   - プロジェクトの重要なマイルストーン時

### 現在のブランチ状況
1. feature/rekordbox-integration
   - 基本的な機能実装中
   - Pull Request作成の前に必要な作業：
     - 現在再生中の曲情報の取得機能実装
     - テストの追加と実行
     - ドキュメントの最終更新

2. 今後予定されるブランチ
   - feature/artwork-integration
     - アートワーク取得機能の実装
     - 外部ソースとの連携
     - 詳細は別途計画書参照 